"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[53497],{15868:(e,n,s)=>{s.d(n,{A:()=>o});var t=s(65162),i=s(62540);function o(e){let{header:n,inline:s,updated:o,version:r}=e;return(0,i.jsx)(t.A,{text:`v${r}`,variant:o?"success":"info",className:n?"absolute right-0 top-1.5":s?"inline-block ml-1":"ml-2"})}},43023:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>a});var t=s(63696);const i={},o=t.createContext(i);function r(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(o.Provider,{value:n},e.children)}},52390:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"guides/extensions","title":"Extensions","description":"An extension is a WASM plugin that allows you to extend moon with additional functionality, have","source":"@site/docs/guides/extensions.mdx","sourceDirName":"guides","slug":"/guides/extensions","permalink":"/docs/guides/extensions","draft":false,"unlisted":false,"editUrl":"https://github.com/moonrepo/moon/tree/master/website/docs/guides/extensions.mdx","tags":[{"inline":true,"label":"extension","permalink":"/docs/tags/extension"},{"inline":true,"label":"wasm","permalink":"/docs/tags/wasm"},{"inline":true,"label":"plugin","permalink":"/docs/tags/plugin"}],"version":"current","frontMatter":{"title":"Extensions","tags":["extension","wasm","plugin"],"toc_max_heading_level":4},"sidebar":"guides","previous":{"title":"Docker integration","permalink":"/docs/guides/docker"},"next":{"title":"MCP integration","permalink":"/docs/guides/mcp"}}');var i=s(62540),o=s(43023),r=s(15868);const a={title:"Extensions",tags:["extension","wasm","plugin"],toc_max_heading_level:4},l=void 0,c={},d=[{value:"Using extensions",id:"using-extensions",level:2},{value:"Built-in extensions",id:"built-in-extensions",level:2},{value:"<code>download</code>",id:"download",level:3},{value:"Arguments",id:"arguments",level:4},{value:"<code>migrate-nx</code><VersionLabel></VersionLabel>",id:"migrate-nx",level:3},{value:"Arguments",id:"arguments-1",level:4},{value:"Unsupported",id:"unsupported",level:4},{value:"<code>migrate-turborepo</code><VersionLabel></VersionLabel>",id:"migrate-turborepo",level:3},{value:"Arguments",id:"arguments-2",level:4},{value:"Creating an extension",id:"creating-an-extension",level:2},{value:"Registering metadata",id:"registering-metadata",level:3},{value:"Configuration schema",id:"configuration-schema",level:4},{value:"Implementing execution",id:"implementing-execution",level:3},{value:"Supporting arguments",id:"supporting-arguments",level:3},{value:"Supporting configuration",id:"supporting-configuration",level:3}];function h(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.A,{version:"1.20.0",header:!0}),"\n",(0,i.jsx)(n.p,{children:"An extension is a WASM plugin that allows you to extend moon with additional functionality, have\nwhitelisted access to the file system, and receive partial information about the current workspace.\nExtensions are extremely useful in offering new and unique functionality that doesn't need to be\nbuilt into moon's core. It also enables the community to build and share their own extensions!"}),"\n",(0,i.jsx)(n.h2,{id:"using-extensions",children:"Using extensions"}),"\n",(0,i.jsxs)(n.p,{children:["Before an extension can be executed with the ",(0,i.jsx)(n.a,{href:"../commands/ext",children:(0,i.jsx)(n.code,{children:"moon ext"})})," command, it must be\nconfigured with the ",(0,i.jsx)(n.a,{href:"../config/workspace#extensions",children:(0,i.jsx)(n.code,{children:"extensions"})})," setting in\n",(0,i.jsx)(n.a,{href:"../config/workspace",children:(0,i.jsx)(n.code,{children:".moon/workspace.yml"})})," (excluding ",(0,i.jsx)(n.a,{href:"#built-in-extensions",children:"built-in's"}),")."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/workspace.yml"',children:"extensions:\n  example:\n    plugin: 'https://example.com/path/to/example.wasm'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Once configured, it can be executed with ",(0,i.jsx)(n.a,{href:"../commands/ext",children:(0,i.jsx)(n.code,{children:"moon ext"})})," by name. Arguments unique to\nthe extension ",(0,i.jsx)(n.em,{children:"must"})," be passed after a ",(0,i.jsx)(n.code,{children:"--"})," separator."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"$ moon ext example -- --arg1 --arg2\n"})}),"\n",(0,i.jsx)(n.h2,{id:"built-in-extensions",children:"Built-in extensions"}),"\n",(0,i.jsxs)(n.p,{children:["moon is shipped with a few built-in extensions that are configured and enabled by default. Official\nmoon extensions are built and published in our ",(0,i.jsx)(n.a,{href:"https://github.com/moonrepo/moon-extensions",children:"moonrepo/moon-extensions"})," repository."]}),"\n",(0,i.jsx)(n.h3,{id:"download",children:(0,i.jsx)(n.code,{children:"download"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"download"})," extension can be used to download a file from a URL into the current workspace, as\ndefined by the ",(0,i.jsx)(n.code,{children:"--url"})," argument. For example, say we want to download the latest ",(0,i.jsx)(n.a,{href:"/proto",children:"proto"}),"\nbinary:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"$ moon ext download --\\\n  --url https://github.com/moonrepo/proto/releases/latest/download/proto_cli-aarch64-apple-darwin.tar.xz\n"})}),"\n",(0,i.jsxs)(n.p,{children:["By default this will download ",(0,i.jsx)(n.code,{children:"proto_cli-aarch64-apple-darwin.tar.xz"})," into the current working\ndirectory. To customize the location, use the ",(0,i.jsx)(n.code,{children:"--dest"})," argument. However, do note that the\ndestination ",(0,i.jsx)(n.em,{children:"must be"})," within the current moon workspace, as only certain directories are whitelisted\nfor WASM."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"$ moon ext download --\\\n  --url https://github.com/moonrepo/proto/releases/latest/download/proto_cli-aarch64-apple-darwin.tar.xz\\\n  --dest ./temp\n"})}),"\n",(0,i.jsx)(n.h4,{id:"arguments",children:"Arguments"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--url"})," (required) - URL of a file to download."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--dest"})," - Destination folder to save the file. Defaults to the current working directory."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--name"})," - Override the file name. Defaults to the file name in the URL."]}),"\n"]}),"\n",(0,i.jsxs)(n.h3,{id:"migrate-nx",children:[(0,i.jsx)(n.code,{children:"migrate-nx"}),(0,i.jsx)(r.A,{version:"1.22.0"})]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["This extension is currently ",(0,i.jsx)(n.em,{children:"experimental"})," and will be improved over time."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"migrate-nx"})," extension can be used to migrate an Nx powered repository to moon. This process\nwill convert the root ",(0,i.jsx)(n.code,{children:"nx.json"})," and ",(0,i.jsx)(n.code,{children:"workspace.json"})," files, and any ",(0,i.jsx)(n.code,{children:"project.json"})," and\n",(0,i.jsx)(n.code,{children:"package.json"})," files found within the repository. The following changes are made:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Migrates ",(0,i.jsx)(n.code,{children:"targetDefaults"})," as global tasks to ",(0,i.jsx)(n.a,{href:"../config/tasks#tasks",children:(0,i.jsx)(n.code,{children:".moon/tasks/node.yml"})})," (or\n",(0,i.jsx)(n.code,{children:"bun.yml"}),"), ",(0,i.jsx)(n.code,{children:"namedInputs"})," as file groups, ",(0,i.jsx)(n.code,{children:"workspaceLayout"})," as projects, and more."]}),"\n",(0,i.jsxs)(n.li,{children:["Migrates all ",(0,i.jsx)(n.code,{children:"project.json"})," settings to ",(0,i.jsx)(n.a,{href:"../config/project#tasks",children:(0,i.jsx)(n.code,{children:"moon.yml"})})," equivalent settings.\nTarget to task conversion assumes the following:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Target ",(0,i.jsx)(n.code,{children:"executor"})," will be removed, and we'll attempt to extract the appropriate npm package\ncommand. For example, ",(0,i.jsx)(n.code,{children:"@nx/webpack:build"})," -> ",(0,i.jsx)(n.code,{children:"webpack build"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Target ",(0,i.jsx)(n.code,{children:"options"})," will be converted to task ",(0,i.jsx)(n.code,{children:"args"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"{projectRoot}"})," and ",(0,i.jsx)(n.code,{children:"{workspaceRoot}"})," interpolations will be replaced with moon tokens."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"$ moon ext migrate-nx\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsx)(n.p,{children:"Nx and moon are quite different, so many settings are either ignored when converting, or are not a\n1:1 conversion. We do our best to convert as much as possible, but some manual patching will most\nlikely be required! We suggest testing each converted task 1-by-1 to ensure it works as expected."})}),"\n",(0,i.jsx)(n.h4,{id:"arguments-1",children:"Arguments"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--bun"})," - Migrate to Bun based commands instead of Node.js."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--cleanup"})," - Remove Nx configs/files after migrating."]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"unsupported",children:"Unsupported"}),"\n",(0,i.jsx)(n.p,{children:"The following features are not supported in moon, and are ignored when converting."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Most settings in ",(0,i.jsx)(n.code,{children:"nx.json"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Named input variants: external dependencies, dependent task output files, dependent project\ninputs, or runtime commands."}),"\n",(0,i.jsxs)(n.li,{children:["Target ",(0,i.jsx)(n.code,{children:"configurations"})," and ",(0,i.jsx)(n.code,{children:"defaultConfiguration"}),". Another task will be created instead that uses\n",(0,i.jsx)(n.code,{children:"extends"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Project ",(0,i.jsx)(n.code,{children:"root"})," and ",(0,i.jsx)(n.code,{children:"sourceRoot"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.h3,{id:"migrate-turborepo",children:[(0,i.jsx)(n.code,{children:"migrate-turborepo"}),(0,i.jsx)(r.A,{version:"1.21.0"})]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"migrate-turborepo"})," extension can be used to migrate a Turborepo powered repository to moon.\nThis process will convert the root ",(0,i.jsx)(n.code,{children:"turbo.json"})," file, and any ",(0,i.jsx)(n.code,{children:"turbo.json"})," files found within the\nrepository. The following changes are made:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Migrates ",(0,i.jsx)(n.code,{children:"pipeline"})," (v1) and ",(0,i.jsx)(n.code,{children:"tasks"})," (v2) global tasks to\n",(0,i.jsx)(n.a,{href:"../config/tasks#tasks",children:(0,i.jsx)(n.code,{children:".moon/tasks/node.yml"})})," (or ",(0,i.jsx)(n.code,{children:"bun.yml"}),") and project scoped tasks to\n",(0,i.jsx)(n.a,{href:"../config/project#tasks",children:(0,i.jsx)(n.code,{children:"moon.yml"})}),". Task commands will execute ",(0,i.jsx)(n.code,{children:"package.json"})," scripts through a\npackage manager."]}),"\n",(0,i.jsxs)(n.li,{children:["Migrates root ",(0,i.jsx)(n.code,{children:"global*"})," settings to ",(0,i.jsx)(n.a,{href:"../config/tasks#implicitinputs",children:(0,i.jsx)(n.code,{children:".moon/tasks/node.yml"})})," (or\n",(0,i.jsx)(n.code,{children:"bun.yml"}),") as ",(0,i.jsx)(n.code,{children:"implicitInputs"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"$ moon ext migrate-turborepo\n"})}),"\n",(0,i.jsx)(n.h4,{id:"arguments-2",children:"Arguments"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--bun"})," - Migrate to Bun based commands instead of Node.js."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"--cleanup"})," - Remove Turborepo configs/files after migrating."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"creating-an-extension",children:"Creating an extension"}),"\n",(0,i.jsxs)(n.p,{children:["Refer to our ",(0,i.jsx)(n.a,{href:"./wasm-plugins",children:"official WASM guide"})," for more information on how our WASM plugins\nwork, critical concepts to know, how to create a plugin, and more. Once you have a good\nunderstanding, you may continue this specific guide."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["Refer to our ",(0,i.jsx)(n.a,{href:"https://github.com/moonrepo/moon-extensions",children:"moonrepo/moon-extensions"})," repository for in-depth examples."]})}),"\n",(0,i.jsx)(n.h3,{id:"registering-metadata",children:"Registering metadata"}),"\n",(0,i.jsxs)(n.p,{children:["Before we begin, we must implement the ",(0,i.jsx)(n.code,{children:"register_extension"})," function, which simply provides some\nmetadata that we can bubble up to users, or to use for deeper integrations."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:'use extism_pdk::*;\nuse moon_pdk::*;\n\n#[plugin_fn]\npub fn register_extension(Json(input): Json<ExtensionMetadataInput>) -> FnResult<Json<ExtensionMetadataOutput>> {\n   Ok(Json(ExtensionMetadataOutput {\n        name: "Extension name".into(),\n        description: Some("A description about what the extension does.".into()),\n        plugin_version: env!("CARGO_PKG_VERSION").into(),\n        ..ExtensionMetadataOutput::default()\n    }))\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"configuration-schema",children:"Configuration schema"}),"\n",(0,i.jsxs)(n.p,{children:["If you are using ",(0,i.jsx)(n.a,{href:"#supporting-configuration",children:"configuration"}),", you can register the shape of the\nconfiguration using the ",(0,i.jsx)(n.a,{href:"https://crates.io/crates/schematic",children:(0,i.jsx)(n.code,{children:"schematic"})})," crate. This shape will be\nused to generate outputs such as JSON schemas, or TypeScript types."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:"#[plugin_fn]\npub fn register_extension(_: ()) -> FnResult<Json<ExtensionMetadataOutput>> {\n    Ok(Json(ExtensionMetadataOutput {\n        // ...\n        config_schema: Some(schematic::SchemaBuilder::generate::<NodeConfig>()),\n    }))\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Schematic is a heavy library, so we suggest adding the dependency like so:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-toml",children:'[dependencies]\nschematic = { version = "*", default-features = false, features = ["schema"] }\n'})}),"\n",(0,i.jsx)(n.h3,{id:"implementing-execution",children:"Implementing execution"}),"\n",(0,i.jsxs)(n.p,{children:["Extensions support a single plugin function, ",(0,i.jsx)(n.code,{children:"execute_extension"}),", which is called by the\n",(0,i.jsx)(n.a,{href:"../commands/ext",children:(0,i.jsx)(n.code,{children:"moon ext"})})," command to execute the extension. This is where all your business\nlogic will reside."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:'#[host_fn]\nextern "ExtismHost" {\n    fn host_log(input: Json<HostLogInput>);\n}\n\n#[plugin_fn]\npub fn execute_extension(Json(input): Json<ExecuteExtensionInput>) -> FnResult<()> {\n  host_log!(stdout, "Executing extension!");\n\n  Ok(())\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"supporting-arguments",children:"Supporting arguments"}),"\n",(0,i.jsxs)(n.p,{children:["Most extensions will require arguments, as it provides a mechanism for users to pass information\ninto the WASM runtime. To parse arguments, we provide the\n",(0,i.jsx)(n.a,{href:"https://docs.rs/clap/latest/clap/trait.Args.html",children:(0,i.jsx)(n.code,{children:"Args"})})," trait/macro from the\n",(0,i.jsx)(n.a,{href:"https://crates.io/crates/clap",children:"clap"})," crate. Refer to their\n",(0,i.jsx)(n.a,{href:"https://docs.rs/clap/latest/clap/_derive/index.html",children:"official documentation on usage"})," (we don't\nsupport everything)."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:"use moon_pdk::*;\n\n#[derive(Args)]\npub struct ExampleExtensionArgs {\n  // --url, -u\n  #[arg(long, short = 'u', required = true)]\n  pub url: String,\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Once your struct has been defined, you can parse the provided input arguments using the\n",(0,i.jsx)(n.a,{href:"https://docs.rs/moon_pdk/latest/moon_pdk/args/fn.parse_args.html",children:(0,i.jsx)(n.code,{children:"parse_args"})})," function."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:"#[plugin_fn]\npub fn execute_extension(Json(input): Json<ExecuteExtensionInput>) -> FnResult<()> {\n  let args = parse_args::<ExampleExtensionArgs>(&input.args)?;\n\n  args.url; // --url\n\n  Ok(())\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"supporting-configuration",children:"Supporting configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Users can configure ",(0,i.jsx)(n.a,{href:"../config/workspace#extensions",children:"extensions"})," with additional settings in\n",(0,i.jsx)(n.a,{href:"../config/workspace",children:(0,i.jsx)(n.code,{children:".moon/workspace.yml"})}),". Do note that settings should be in camelCase for them\nto be parsed correctly!"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/workspace.yml"',children:"extensions:\n  example:\n    plugin: 'file://./path/to/example.wasm'\n    someSetting: 'abc'\n    anotherSetting: 123\n"})}),"\n",(0,i.jsxs)(n.p,{children:["In the plugin, we can map these settings (excluding ",(0,i.jsx)(n.code,{children:"plugin"}),") into a struct. The ",(0,i.jsx)(n.code,{children:"Default"})," trait\nmust be implemented to handle situations where settings were not configured, or some are missing."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:"config_struct!(\n  #[derive(Default)]\n  pub struct ExampleExtensionConfig {\n    pub some_setting: String,\n    pub another_setting: u32,\n  }\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Once your struct has been defined, you can access the configuration using the\n",(0,i.jsx)(n.a,{href:"https://docs.rs/moon_pdk/latest/moon_pdk/extension/fn.get_extension_config.html",children:(0,i.jsx)(n.code,{children:"get_extension_config"})}),"\nfunction."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:"#[plugin_fn]\npub fn execute_extension(Json(input): Json<ExecuteExtensionInput>) -> FnResult<()> {\n  let config = get_extension_config::<ExampleExtensionConfig>()?;\n\n  config.another_setting; // 123\n\n  Ok(())\n}\n"})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},65162:(e,n,s)=>{s.d(n,{A:()=>a});var t=s(11750),i=s(74599),o=s(62540);const r={failure:"bg-red-100 text-red-900",info:"bg-pink-100 text-pink-900",success:"bg-green-100 text-green-900",warning:"bg-orange-100 text-orange-900"};function a(e){let{className:n,icon:s,text:a,variant:l}=e;return(0,o.jsxs)("span",{className:(0,t.A)("inline-flex items-center px-1 py-0.5 rounded text-xs font-bold uppercase",l?r[l]:"bg-gray-100 text-gray-800",n),children:[s&&(0,o.jsx)(i.A,{icon:s,className:"mr-1"}),a]})}}}]);