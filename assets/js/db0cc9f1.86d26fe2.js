"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[28413],{13856:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"guides/remote-cache","title":"Remote caching","description":"Is your CI pipeline running slower than usual? Are you tired of running the same build over and over","source":"@site/docs/guides/remote-cache.mdx","sourceDirName":"guides","slug":"/guides/remote-cache","permalink":"/docs/guides/remote-cache","draft":false,"unlisted":false,"editUrl":"https://github.com/moonrepo/moon/tree/master/website/docs/guides/remote-cache.mdx","tags":[],"version":"current","frontMatter":{"title":"Remote caching","toc_max_heading_level":6},"sidebar":"guides","previous":{"title":"Pkl configuration","permalink":"/docs/guides/pkl-config"},"next":{"title":"Root-level project","permalink":"/docs/guides/root-project"}}');var s=t(62540),i=t(43023),r=t(15868);const a={title:"Remote caching",toc_max_heading_level:6},c=void 0,l={},d=[{value:"Self-hosted <VersionLabel></VersionLabel>",id:"self-hosted-",level:2},{value:"Host your service",id:"host-your-service",level:3},{value:"Configure remote caching",id:"configure-remote-caching",level:3},{value:"TLS and mTLS",id:"tls-and-mtls",level:4},{value:"Cloud-hosted: Depot<VersionLabel></VersionLabel>",id:"cloud-hosted-depot",level:2},{value:"FAQ",id:"faq",level:2},{value:"What is an artifact?",id:"what-is-an-artifact",level:4},{value:"Do I have to use remote caching?",id:"do-i-have-to-use-remote-caching",level:4},{value:"Does remote caching store source code?",id:"does-remote-caching-store-source-code",level:4},{value:"Does moon collect any personally identifiable information?",id:"does-moon-collect-any-personally-identifiable-information",level:4},{value:"Are artifacts encrypted?",id:"are-artifacts-encrypted",level:4}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Is your CI pipeline running slower than usual? Are you tired of running the same build over and over\nalthough nothing has changed? Do you wish to reuse the same local cache across other machines and\nenvironments? These are just a few scenarios that remote caching aims to solve."}),"\n",(0,s.jsx)(n.p,{children:"Remote caching is a system that shares artifacts to improve performance, reduce unnecessary\ncomputation time, and alleviate resources. It achieves this by uploading hashed artifacts to a cloud\nstorage provider, like AWS S3 or Google Cloud, and downloading them on demand when a build matches a\nderived hash."}),"\n",(0,s.jsx)(n.p,{children:"To make use of remote caching, we provide 2 solutions."}),"\n",(0,s.jsxs)(n.h2,{id:"self-hosted-",children:["Self-hosted ",(0,s.jsx)(r.A,{version:"1.30.0"})]}),"\n",(0,s.jsxs)(n.p,{children:["This solution allows you to host any remote caching service that is compatible with the\n",(0,s.jsx)(n.a,{href:"https://github.com/bazelbuild/remote-apis/tree/main/build/bazel/remote/execution/v2",children:"Bazel Remote Execution v2 API"}),",\nsuch as ",(0,s.jsx)(n.a,{href:"https://github.com/buchgr/bazel-remote",children:(0,s.jsx)(n.code,{children:"bazel-remote"})}),". When using this solution, the\nfollowing RE API features must be enabled:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Action result caching"}),"\n",(0,s.jsx)(n.li,{children:"Content addressable storage caching"}),"\n",(0,s.jsx)(n.li,{children:"SHA256 digest hashing"}),"\n",(0,s.jsx)(n.li,{children:"gRPC requests"}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"warning",children:(0,s.jsx)(n.p,{children:"This feature and its implementation is currently unstable, and its documentation is incomplete.\nPlease report any issues on GitHub or through Discord!"})}),"\n",(0,s.jsx)(n.h3,{id:"host-your-service",children:"Host your service"}),"\n",(0,s.jsxs)(n.p,{children:["When you have chosen (or built) a compatible service, host it and make it available through gRPC (we\ndo not support HTTP at this time). For example, if you plan to use ",(0,s.jsx)(n.code,{children:"bazel-remote"}),", you can do\nsomething like the following:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"bazel-remote --dir /path/to/moon-cache --max_size 10 --storage_mode uncompressed --grpc_address 0.0.0.0:9092\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If you've configured the ",(0,s.jsx)(n.a,{href:"../config/workspace#compression",children:(0,s.jsx)(n.code,{children:"remote.cache.compression"})}),' setting to\n"zstd", you\'ll need to run the binary with that storage mode as well.']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"bazel-remote --dir /path/to/moon-cache --max_size 10 --storage_mode zstd --grpc_address 0.0.0.0:9092\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["View the official ",(0,s.jsx)(n.a,{href:"https://github.com/buchgr/bazel-remote#usage",children:(0,s.jsx)(n.code,{children:"bazel-remote"})})," documentation for\nall the available options, like storing artifacts in S3, configuring authentication (TLS/mTLS),\nproxies, and more."]})}),"\n",(0,s.jsx)(n.h3,{id:"configure-remote-caching",children:"Configure remote caching"}),"\n",(0,s.jsxs)(n.p,{children:["Once your service is running, you can enable remote caching by configuring the\n",(0,s.jsx)(n.a,{href:"../config/workspace#unstable_remote",children:(0,s.jsx)(n.code,{children:"unstable_remote"})})," settings in\n",(0,s.jsx)(n.a,{href:"../config/workspace",children:(0,s.jsx)(n.code,{children:".moon/workspace.yml"})}),". At minimum, the only setting that is required is\n",(0,s.jsx)(n.code,{children:"host"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/workspace.yml"',children:"unstable_remote:\n  host: 'grpc://your-host.com:9092'\n"})}),"\n",(0,s.jsx)(n.h4,{id:"tls-and-mtls",children:"TLS and mTLS"}),"\n",(0,s.jsxs)(n.p,{children:["We have rudimentary support for TLS and mTLS, but it's very unstable, and has not been thoroughly\ntested. There's also ",(0,s.jsx)(n.a,{href:"https://github.com/hyperium/tonic/issues/1652",children:"many"}),"\n",(0,s.jsx)(n.a,{href:"https://github.com/hyperium/tonic/issues/1989",children:"many"}),"\n",(0,s.jsx)(n.a,{href:"https://github.com/hyperium/tonic/issues/1033",children:"issues"})," around authentication in Tonic."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/workspace.yml"',children:"# TLS\nunstable_remote:\n  host: 'grpcs://your-host.com:9092'\n  tls:\n    cert: 'certs/ca.pem'\n    domain: 'your-host.com'\n\n# mTLS\nunstable_remote:\n  host: 'grpcs://your-host.com:9092'\n  mtls:\n    caCert: 'certs/ca.pem'\n    clientCert: 'certs/client.pem'\n    clientKey: 'certs/client.key'\n    domain: 'your-host.com'\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"cloud-hosted-depot",children:["Cloud-hosted: Depot",(0,s.jsx)(r.A,{version:"1.32.0"})]}),"\n",(0,s.jsxs)(n.p,{children:["If you'd prefer not to host your own solution, you could use\n",(0,s.jsx)(n.a,{href:"https://depot.dev/products/cache",children:"Depot Cache"}),", a cloud-based caching solution. To make use of\nDepot, follow these steps:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Create an account on ",(0,s.jsx)(n.a,{href:"https://depot.dev",children:"depot.dev"})]}),"\n",(0,s.jsx)(n.li,{children:"Create an organization"}),"\n",(0,s.jsx)(n.li,{children:"Go to organization settings -> API tokens"}),"\n",(0,s.jsx)(n.li,{children:"Create a new API token"}),"\n",(0,s.jsxs)(n.li,{children:["Add the token as a ",(0,s.jsx)(n.code,{children:"DEPOT_TOKEN"})," environment variable to your moon pipelines"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Once these steps have been completed, you can enable remote caching in moon with the following\nconfiguration. If your Depot account has more than 1 organization, you'll need to set the\n",(0,s.jsx)(n.code,{children:"X-Depot-Org"})," header."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/workspace.yml"',children:"unstable_remote:\n  host: 'grpcs://cache.depot.dev'\n  auth:\n    token: 'DEPOT_TOKEN'\n    headers:\n      'X-Depot-Org': '<your-org-id>'\n"})}),"\n",(0,s.jsx)(n.h2,{id:"faq",children:"FAQ"}),"\n",(0,s.jsx)(n.h4,{id:"what-is-an-artifact",children:"What is an artifact?"}),"\n",(0,s.jsxs)(n.p,{children:["In the context of moon and remote caching, an artifact is the\n",(0,s.jsx)(n.a,{href:"../config/project#outputs",children:"outputs of a task"}),", as well as the stdout and stderr of the task that\ngenerated the outputs. Artifacts are uniquely identified by the\n",(0,s.jsx)(n.a,{href:"../concepts/cache#hashing",children:"moon generated hash"}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"do-i-have-to-use-remote-caching",children:"Do I have to use remote caching?"}),"\n",(0,s.jsxs)(n.p,{children:["No, remote caching is ",(0,s.jsx)(n.em,{children:"optional"}),". It's intended purpose is to store long lived build artifacts to\nspeed up CI pipelines, and optionally local development. For the most part,\n",(0,s.jsx)(n.a,{href:"../commands/ci",children:(0,s.jsx)(n.code,{children:"moon ci"})})," does a great job of only running what's affected in pull requests, and\nis a great starting point."]}),"\n",(0,s.jsx)(n.h4,{id:"does-remote-caching-store-source-code",children:"Does remote caching store source code?"}),"\n",(0,s.jsxs)(n.p,{children:["No, remote caching ",(0,s.jsx)(n.em,{children:"does not"})," store source code. It stores the\n",(0,s.jsx)(n.a,{href:"../config/project#outputs",children:"outputs of a task"}),", which is typically built and compiled code. To\nverify this, you can inspect the tar archives in ",(0,s.jsx)(n.code,{children:".moon/cache/outputs"}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"does-moon-collect-any-personally-identifiable-information",children:"Does moon collect any personally identifiable information?"}),"\n",(0,s.jsx)(n.p,{children:"No, moon does not collect any PII as part of the remote caching process."}),"\n",(0,s.jsx)(n.h4,{id:"are-artifacts-encrypted",children:"Are artifacts encrypted?"}),"\n",(0,s.jsx)(n.p,{children:"We do not encrypt on moon's side, as encryption is provided by your cloud storage provider."})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},15868:(e,n,t)=>{t.d(n,{A:()=>i});var o=t(65162),s=t(62540);function i(e){let{header:n,inline:t,updated:i,version:r}=e;return(0,s.jsx)(o.A,{text:`v${r}`,variant:i?"success":"info",className:n?"absolute right-0 top-1.5":t?"inline-block ml-1":"ml-2"})}},43023:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var o=t(63696);const s={},i=o.createContext(s);function r(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),o.createElement(i.Provider,{value:n},e.children)}},65162:(e,n,t)=>{t.d(n,{A:()=>a});var o=t(11750),s=t(74599),i=t(62540);const r={failure:"bg-red-100 text-red-900",info:"bg-pink-100 text-pink-900",success:"bg-green-100 text-green-900",warning:"bg-orange-100 text-orange-900"};function a(e){let{className:n,icon:t,text:a,variant:c}=e;return(0,i.jsxs)("span",{className:(0,o.A)("inline-flex items-center px-1 py-0.5 rounded text-xs font-bold uppercase",c?r[c]:"bg-gray-100 text-gray-800",n),children:[t&&(0,i.jsx)(s.A,{icon:t,className:"mr-1"}),a]})}}}]);